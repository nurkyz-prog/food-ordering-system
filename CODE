import pytest
import jwt
import datetime
import logging
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import create_engine

# # # 1. BÖLÜM: SINGLETON VERİTABANI BAĞLANTISI (Database Connection) # # #
class DatabaseConnection:
    __instance = None

    @staticmethod
    def get_instance():
        if DatabaseConnection.__instance is None:
            DatabaseConnection()
        return DatabaseConnection.__instance

    def __init__(self):
        if DatabaseConnection.__instance is not None:
            raise Exception("This class is a singleton!")
        else:
            self.connection = self.create_connection()
            DatabaseConnection.__instance = self

    def create_connection(self):
        # Uygulamanın kullanacağı ana veritabanı bağlantısı
        return create_engine('sqlite:///food_ordering.db')

# # # 2. BÖLÜM: VERİTABANI MODELLERİ (Models) # # #
db = SQLAlchemy()

class User(db.Model):
    __tablename__ = "users"
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True)
    password = db.Column(db.String(255))

class MenuItem(db.Model):
    __tablename__ = "menu_items"
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    price = db.Column(db.Float)

class Order(db.Model):
    __tablename__ = "orders"
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id"))
    status = db.Column(db.String(50))

# # # 3. BÖLÜM: LOGLAMA SİSTEMİ (Logger) # # #
def start_logging(log_file="app.log"):
    logging.basicConfig(
        filename=log_file,
        level=logging.INFO,
        force=True  # Testlerin çakışmaması için zorunlu
    )
    logging.info("Application started successfully")

# # # 4. BÖLÜM: KİMLİK DOĞRULAMA (JWT Auth) # # #
def create_jwt_token(user_id):
    payload = {
        'user_id': user_id,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=2)
    }
    return jwt.encode(payload, 'SECRET_KEY', algorithm='HS256')

# # # 5. BÖLÜM: TEST YAPILANDIRMALARI (Pytest Fixtures) # # #

@pytest.fixture
def test_app():
    """Genel uygulama ve veritabanı testleri için fixture"""
    app = Flask(__name__)
    app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///:memory:"
    app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
    db.init_app(app)
    with app.app_context():
        db.create_all()
        yield app, db

@pytest.fixture
def app_fixture():
    """Hata yakalayıcı testleri için fixture"""
    app = Flask(__name__)
    try:
        from error_handler import register_error_handlers
        register_error_handlers(app)
    except ImportError:
        pass # error_handler.py yoksa hata vermez
    return app
